# Backend Service Design

## 1. è®¾è®¡ç›®æ ‡
è¦†ç›–å¤š Persona ä¼šè¯ã€å¯æ‰©å±• RAGã€ä½å»¶è¿Ÿæ¶ˆæ¯ç”Ÿæˆã€å¯é è°ƒåº¦ã€‚

## 2. æœåŠ¡åˆ†å±‚
API å±‚ -> åº”ç”¨åè°ƒå±‚ -> RuntimeSession ç®¡ç† -> Scheduler/é˜Ÿåˆ—å±‚ -> æ•°æ®ä¸å‘é‡å­˜å‚¨å±‚ã€‚

## 3. è¯·æ±‚ç”Ÿå‘½å‘¨æœŸ
å®¢æˆ·ç«¯å‘èµ· `POST /api/sessions/{id}/messages` æˆ– WebSocket å¸¦ `ws_token` -> è·¯ç”±éªŒè¯ -> Persona & Session ç»‘å®š -> å…¥é˜Ÿ -> RuntimeSession æ¶ˆè´¹ -> è°ƒç”¨ LLM æˆ–æ£€ç´¢ -> ç”Ÿæˆæ¶ˆæ¯ -> æ¨é€ç»™å®¢æˆ·ç«¯ã€‚

## 4. API æ¦‚è¦
- POST /api/sessions/{id}/messages å‘é€æ¶ˆæ¯
- GET /api/sessions/{id} è·å–ä¼šè¯
- WebSocket /ws/sessions/{id}?ws_token=...
- POST /api/personas/{id}/ingest - RAG çŸ¥è¯†æ‘„å–
- POST /api/personas/{id}/ingest_text - æ–‡æœ¬æ‘„å–

## 5. æ•°æ®æ¨¡å‹
åŒ…å« Session, Message, Persona, RuntimeSession, å‘é‡æ£€ç´¢é›†åˆï¼Œæ¶ˆæ¯ä¸ Persona å¤šå¯¹ä¸€å…³è”ã€‚Persona æ”¯æŒ background å­—æ®µï¼Œè¯¥å­—æ®µå†…å®¹ä¼šè‡ªåŠ¨æ‘„å–åˆ° Milvus å‘é‡åº“ä½œä¸º RAG çŸ¥è¯†æºï¼Œè€Œéç›´æ¥æ‹¼æ¥åˆ°ç³»ç»Ÿæç¤ºã€‚

## 6. Runtime & Scheduler ç­–ç•¥
RuntimeSession ä¿æŒ sticky session è¡Œä¸ºï¼Œå¯¹åŒä¸€ä¼šè¯æ¶ˆæ¯ä½¿ç”¨åŒä¸€æ‰§è¡Œä¸Šä¸‹æ–‡ï¼›ä½¿ç”¨ asyncio.Queue ä½œä¸ºå†…éƒ¨è°ƒåº¦ç»“æ„ï¼Œæ”¯æŒä¼˜å…ˆçº§æ‰©å±•ã€‚

## 7. é…ç½®ä¸ä¾èµ–
æ•°æ®åº“é©±åŠ¨çš„ API é…ç½®è§£æï¼ˆAPIProfile è¡¨ï¼‰ï¼Œè¿è¡Œæ—¶åŠ¨æ€åŠ è½½ï¼›ä¾èµ– OpenAI å…¼å®¹æ¥å£ã€Milvusã€SQLAlchemyã€FastAPIã€LangChainã€‚

## 8. å¯è§‚æµ‹æ€§
è®¡åˆ’æ·»åŠ  tracing (OpenTelemetry)ã€metrics (å¤„ç†è€—æ—¶ã€é˜Ÿåˆ—é•¿åº¦)ã€structured loggingã€‚

## 9. è¿­ä»£é‡Œç¨‹ç¢‘
- âœ… é‡Œç¨‹ç¢‘1ï¼šåŸºç¡€ä¼šè¯ä¸æ¶ˆæ¯æµè½¬
- âœ… é‡Œç¨‹ç¢‘2ï¼šRAG é›†æˆï¼ˆæ‘„å–ã€æ£€ç´¢ã€ç”Ÿæˆï¼‰
- âœ… é‡Œç¨‹ç¢‘3ï¼šæ•°æ®åº“é…ç½®è§£æå™¨
- ğŸ”„ é‡Œç¨‹ç¢‘4ï¼šå‰ç«¯ RAG ç•Œé¢
- ğŸ“‹ é‡Œç¨‹ç¢‘5ï¼šå¯è§‚æµ‹æ€§ä¸æ²»ç†

## 10. RAG é›†æˆä¸ Background å­—æ®µ (å·²å®Œæˆ)
- **æ‘„å–æµç¨‹**: URL æŠ“å– -> æ–‡æœ¬åˆ‡ç‰‡ -> Embeddings -> Milvus å­˜å‚¨
- **æ£€ç´¢æµç¨‹**: å‘é‡ç›¸ä¼¼åº¦æ£€ç´¢ -> Top-K æ–‡æ¡£ -> æ ¼å¼åŒ–ä¸Šä¸‹æ–‡
- **ç”Ÿæˆæµç¨‹**: ä¸Šä¸‹æ–‡æ³¨å…¥ç³»ç»Ÿæç¤º -> LLM è°ƒç”¨ -> æµå¼è¿”å›
- **é…ç½®è§£æ**: æŒ‰ Persona åŠ¨æ€è§£æ API é…ç½®ï¼ˆmodel, base_url, api_keyï¼‰
- **ä¾èµ–æ³¨å…¥**: rag_dependencies.py é¿å…å¾ªç¯ä¾èµ–ï¼Œpersona_function.py å¼‚æ­¥æ³¨å…¥æ£€ç´¢ä¸Šä¸‹æ–‡
- **Background è‡ªåŠ¨æ‘„å–**: åˆ›å»º/æ›´æ–° Persona æ—¶ï¼Œbackground å­—æ®µè‡ªåŠ¨è§¦å‘ RAG ingest_textï¼Œå­˜å‚¨åˆ°å‘é‡åº“è€Œéç›´æ¥æ‹¼æ¥


## 11. è¿›åº¦è®°å½•
ä½¿ç”¨ docs/ ç›®å½•ä¸‹è¿›åº¦æ–‡ä»¶æ¯æ—¥è®°å½•ï¼Œå«å®Œæˆé¡¹ä¸é—®é¢˜ã€‚

**æœ€æ–°æ›´æ–° (2025-11-26)**: RAG å…¨é“¾è·¯é›†æˆå®Œæˆï¼ŒåŒ…æ‹¬æ•°æ®åº“è§£æå™¨ã€Persona èƒŒæ™¯å­—æ®µæ”¯æŒã€æ— é™ä¼šè¯è¯­ä¹‰ã€‚22 é¡¹æµ‹è¯•å…¨éƒ¨é€šè¿‡ã€‚

## 12. å¼€æ”¾é—®é¢˜
- è°ƒåº¦ä¼˜å…ˆçº§ç­–ç•¥ç»†åŒ–
- RAG ç¼“å­˜åˆ·æ–°ç­–ç•¥
- å¤±è´¥é‡è¯•æ¬¡æ•°ä¸æ­»ä¿¡é˜Ÿåˆ—
- æ£€ç´¢è´¨é‡ä¼˜åŒ–ï¼ˆæŸ¥è¯¢æ”¹å†™ã€é‡æ’åºï¼‰
- å‘é‡åº“ç®¡ç† APIï¼ˆæ¸…ç†ã€ç»Ÿè®¡ï¼‰

## 13. æ¨¡å—æ¥å£é€Ÿè§ˆ
Scheduler: push(message), pop(); RuntimeSession: run(message); Persona: build_prompt(); RAGService: ingest_url(), ingest_text(), retrieve_documents(), generate_response();

## 14. æµ‹è¯•ç­–ç•¥
å•å…ƒæµ‹è¯•ï¼šæ¨¡å‹/è°ƒåº¦/é…ç½®è§£æ/RAG æœåŠ¡ï¼›é›†æˆæµ‹è¯•ï¼šæ¶ˆæ¯ç”Ÿå‘½å‘¨æœŸï¼›æ–‡æ¡£æµ‹è¯•ï¼šè®¾è®¡æ–‡æ¡£å…³é”®æ®µè½ä¸å…³é”®å­—ï¼›æ€§èƒ½æµ‹è¯•ï¼šé«˜å¹¶å‘æ¶ˆæ¯ååã€‚

### å…³é”®è¯å¼•ç”¨
RuntimeSession / asyncio.Queue / sticky session / POST /api/sessions/{id}/messages / ws_token / RAGService / Milvus / retrieve_documents / ingest_url / persona_id
