import{_ as m}from"./index-D9MXyzUu.js";class u{constructor(e={}){this.config=e,this.mermaidInstance=null,this.isLoading=!1,this.lastValidResult="",this.viewStateMap=new WeakMap,this.containerHeight=400}async loadMermaid(){if(this.mermaidInstance)return this.mermaidInstance;if(this.isLoading)return new Promise(e=>{const t=()=>{this.mermaidInstance?e(this.mermaidInstance):setTimeout(t,50)};t()});this.isLoading=!0;try{const{default:e}=await m(async()=>{const{default:t}=await import("./mermaid.esm.min-DVNKuCK_.js");return{default:t}},[]);return e.initialize({theme:this.config.theme||"default",startOnLoad:!1,suppressErrorRendering:!0,...this.config}),this.mermaidInstance=e,e}catch(e){throw console.error("Failed to load mermaid:",e),new Error("Failed to load mermaid library")}finally{this.isLoading=!1}}async renderToContainer(e,t,a="light"){const i=await this.renderMermaid(t,a);e.innerHTML=i;const s=e.querySelector("svg");s&&(this.initViewState(e,s),this.applyTransform(e,s),s.addEventListener("mousedown",r=>this.onSvgMouseDown(r,e,s)))}initViewState(e,t){let a=t.getAttribute("viewBox"),i=0,s=0;if(a){const l=a.split(/\s+/);i=parseFloat(l[2]),s=parseFloat(l[3])}else i=t.width.baseVal.value||t.getBoundingClientRect().width,s=t.height.baseVal.value||t.getBoundingClientRect().height;const r=e.clientWidth||0,n=this.containerHeight;let o=1;i&&s&&r&&n&&(o=Math.min(r/i,n/s,1)),this.viewStateMap.set(e,{scale:o,offsetX:0,offsetY:0,dragging:!1,dragStart:{x:0,y:0},lastOffset:{x:0,y:0}})}applyTransform(e,t){const a=this.viewStateMap.get(e);a&&(t.style.position="absolute",t.style.left="50%",t.style.top="50%",t.style.transform=`translate(-50%, -50%) translate(${a.offsetX}px, ${a.offsetY}px) scale(${a.scale})`,t.style.transformOrigin="center center",t.style.cursor=a.dragging?"grabbing":"grab")}zoomIn(e){const t=e.querySelector("svg"),a=this.viewStateMap.get(e);t&&a&&(a.scale=Math.min(a.scale+.2,3),this.applyTransform(e,t))}zoomOut(e){const t=e.querySelector("svg"),a=this.viewStateMap.get(e);t&&a&&(a.scale=Math.max(a.scale-.2,.2),this.applyTransform(e,t))}reset(e){const t=e.querySelector("svg");t&&(this.initViewState(e,t),this.applyTransform(e,t))}async download(e,t="diagram.png"){const a=e.querySelector("svg");if(a)try{const i=a.cloneNode(!0),s=new XMLSerializer().serializeToString(i),r=`data:image/svg+xml;charset=utf-8,${encodeURIComponent(s)}`,n=new Image;await new Promise((d,h)=>{n.onload=()=>d(),n.onerror=c=>h(new Error("Image loading failed")),n.src=r});const o=document.createElement("canvas"),l=o.getContext("2d");if(!l)throw new Error("Canvas context not available");o.width=n.width*2,o.height=n.height*2,l.fillStyle="white",l.fillRect(0,0,o.width,o.height),l.drawImage(n,0,0),o.toBlob(d=>{if(!d){console.error("Failed to create blob from canvas");return}const h=URL.createObjectURL(d),c=document.createElement("a");c.href=h,c.download=t,document.body.appendChild(c),c.click(),setTimeout(()=>{document.body.removeChild(c),URL.revokeObjectURL(h)},100)},"image/png")}catch(i){console.error("Failed to download diagram:",i)}}onSvgMouseDown(e,t,a){const i=this.viewStateMap.get(t);if(!i)return;i.dragging=!0,i.dragStart={x:e.clientX,y:e.clientY},i.lastOffset={x:i.offsetX,y:i.offsetY};const s=n=>this.onSvgMouseMove(n,t,a),r=()=>this.onSvgMouseUp(t,a,s,r);document.addEventListener("mousemove",s),document.addEventListener("mouseup",r),this.applyTransform(t,a)}onSvgMouseMove(e,t,a){const i=this.viewStateMap.get(t);!i||!i.dragging||(i.offsetX=i.lastOffset.x+(e.clientX-i.dragStart.x),i.offsetY=i.lastOffset.y+(e.clientY-i.dragStart.y),this.applyTransform(t,a))}onSvgMouseUp(e,t,a,i){const s=this.viewStateMap.get(e);s&&(s.dragging=!1,document.removeEventListener("mousemove",a),document.removeEventListener("mouseup",i),this.applyTransform(e,t))}async renderMermaid(e,t="light"){try{const a=await this.loadMermaid();this.config.theme!==t&&(this.config.theme=t,a.initialize({startOnLoad:!1,suppressErrorRendering:!0,theme:t==="dark"?"dark":"default",...this.config}));const i=`mc_mermaid_${Date.now()}_${Math.random().toString(36).substr(2,9)}`,{svg:s}=await a.render(i,e);return this.lastValidResult=s,s}catch{return this.lastValidResult}}}export{u as MermaidService};
